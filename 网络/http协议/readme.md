# HTTP协议（超文本传输协议）
协议就是一个统一的标准。超文本包括文本、脚本、样式表、图片、多媒体信息（视频、音乐等）。HTTP是一种传输协议，主要给浏览器服务，网站是基于HTTP协议的。

http是应用层协议、无状态协议。

两种动作：request、response

HTTP协议是由从客户机到服务器的请求(Request)和从服务器到客户机的响应(response)进行约束和规范。

## 发展历史
- 1991 HTTP/0.9
- 1996 HTTP/1.0
- 1999 HTTP/1.1
- 2015 HTTP/2

# TCP/IP协议栈
![UOWu9S.png](https://s1.ax1x.com/2020/07/23/UOWu9S.png)

TCP/IP是事实上的协议。（4层/5层）
1. 应用层

   - 为用户提供所需要的各种服务，如：HTTP、FTP、DNS、SMTP等。
2. 传输层

   - 为应用层实体提供端到端的通信功能，保证数据包的顺序传送及数据的完整性。
   - TCP（传输控制协议，可靠协议，保证数据被接收）和UDP（用户数据报协议，不可靠协议，没有连接状态，只负责发，不确认结果）
3. 网络层

   - 主要解决主机到主机的通信问题。ip地址分配、PPP协议（建立通信链路）。
4. 数据链路层

   - 在物理上传输信号，将数字信号调制成光信号、电信号、无线电信号等，在物理层上进行传播。如网卡。
5. 物理层

   - 网线、无线电，是一个载体

4层时，将数据链路层和物理层划为一层（网络接口层），这两层都是硬件要做的事情，负责监视数据在主机和网络之间的交换。

ISO/OSI七层协议，是一种规范，一个建议。

## HTTP协议在TCP/IP协议栈中的位置
![](https://s1.ax1x.com/2020/07/23/UOgJAK.th.jpg)

HTTP 默认端口为80。

HTTPS 默认端口为443。

# HTTP的工作过程
一次HTTP操作称为一个事务（多个阶段，任意一个阶段失败就失败）。

建立连接（TCP) -> 请求（HTTP）-> 响应（HTTP） -> 断开连接（TCP）

# 请求和响应
请求报文结构

响应报文结构

# 请求方法
- GET（查）：请求获取Request-URI所标识的资源
- POST（改）：在Request-URI所标识的资源后附加新的数据
- PUT（增）：请求服务器存储一个资源，并用Request-URI作为标识
- DELETE（删）
- HEAD：请求获取由Request-URI所标识的资源的响应消息报头（没有响应体）
- TRACE：请求服务器回送收到的请求消息，主要用于测试或诊断（服务状态）
- CONNECT：HTTP/1.1协议中预留给能够将连接改为管道方式的代理服务器（持久连接）
- OPTIONS：请求查询服务器的性能，或者查询与资源相关的选项和请求
  
日常开发中，一般只用GET、POST。

RESTFUL严格按照请求方法设计接口。

# HTTP/1.1 首部字段
## 通用首部字段（General Header Fields）
| 首部字段名    | 说明                 |
| ------------- | -------------------- |
| Cache-Control | 控制缓存的行为       |
| Connection    | 逐跳首部，连接的管理 |
| Date          | 创建报文的日期时间   |
| Upgrade       | 升级为其他协议       |
| Via           | 代理服务器的相关信息 |
| Warning       | 错误通知             |

## 常见的请求首部字段
| 首部字段名      | 说明                         |
| --------------- | ---------------------------- |
| Accept          | 用户代理期望的 MIME 类型列表 |
| Accept-Charset  | 用户代理支持的字符集         |
| Accept-Encoding | 用户代理支持的压缩方法       |
| Accept-Language | 用户代理期望的页面语言       |
| Authorization   | 升级为其他协议               |
| Via             | 代理服务器的相关信息         |
| Warning         | 错误通知                     |

## 常见的响应首部字段

## 与浏览器缓存相关的首部字段
- `Cache-Control`
- `max-age`
- `ETag`
- `Expires`
- `Last-Modified`
- `Vary`

## 与Cookie相关的首部字段

## GET和POST的区别
GET不向服务器请求数据。

# HTTP缓存
浏览器在磁盘上有一块缓存空间，其大小有个上限。
## HTTP缓存优点
- 减少响应延迟
- 减少网络带宽消耗

## 浏览器的强缓存和协商缓存


# HTTPS协议
对称加密：加密手段与解密手段互为逆运算

非对称加密：加密手段与解密手段没有关系

HTTPS采用非对称加密。

协议协商将http转为https。

TLS

# HTTP 2
- 使用**二进制格式传输**，更高效、更紧凑
  - 所有传输的数据都会被分割，并采用二进制格式编码。
- **多路复用**（长连接的升级），一个网络连接实现并行请求
  - 帧（frame）代表着最小的数据单位，每个帧会标识出该帧属于哪个流，流（stream）也就是多个帧组成的数据流。
  - 多路复用，就是在一个 TCP 连接中可以存在多条流。换句话说，也就是可以发送多个请求，对端可以通过帧中的标识知道属于哪个请求。通过这个技术，可以避免 HTTP 旧版本中的队头阻塞问题，极大的提高传输性能。
  - 只通过一个 TCP 连接就可以传输所有的请求数据，多路复用很好的解决了浏览器限制同一个域名下并发请求的数量的问题，同时也接更容易实现全速传输，毕竟新开一个 TCP 连接都需要慢慢提升传输速度。
- 对**报头压缩**，降低开销（HTTP1.0只能对报文体压缩）
  - 在 HTTP /2 中，使用了 HPACK 压缩格式对传输的 header 进行编码，减少了 header 的大小。并在两端维护了索引表，用于记录出现过的 header ，后面在传输过程中就可以传输已经记录过的 header 的键名，对端收到数据后就可以通过键名找到对应的值。
- **服务器主动推送**，减少请求的延迟
  - 在 HTTP/2 中，服务端可以在客户端某个请求后，主动推送其他资源。
  - 在http1.0中，只有客户端发送请求，服务器才能返回数据。如果要实现推送，ajax必须一直向服务器发送请求（轮询），等待服务器响应。而使用HTTP2.0后，ajax技术将不会被用在推送上。
- 默认使用加密（提高安全性）

## HTTP 2的伪头字段
`key`前面加 `:`

# HTTP 3
因为 HTTP/2 使用了多路复用，一般来说同一域名下只需要使用一个 TCP 连接。当这个连接中出现了丢包的情况，那就会导致 HTTP/2 的表现情况反倒不如 HTTP/1 了。

因为在出现丢包的情况下，整个 TCP 都要开始等待重传，也就导致了后面的所有数据都被阻塞了。但是对于 HTTP/1 来说，可以开启多个 TCP 连接，出现这种情况反到只会影响其中一个连接，剩余的 TCP 连接还可以正常传输数据。

QUIC 协议（Quick UDP Internet Connection）。底层协议基于UDP。

- HTTP3 不是 HTTP2 的扩展
- 他将会是一个全新的 WEB 协议
- 目前处于制订和测试阶段

## QUIC
 UDP 协议虽然效率很高，但是并不是那么的可靠。QUIC 虽然基于 UDP，但是在原本的基础上新增了很多功能，比如多路复用、0-RTT、使用 TLS1.3 加密、流量控制、有序交付、重传等等功能。

### 多路复用
虽然 HTTP/2 支持了多路复用，但是 TCP 协议终究是没有这个功能的。QUIC 原生就实现了这个功能，并且传输的单个数据流可以保证有序交付且不会影响其他的数据流，这样的技术就解决了之前 TCP 存在的问题。

并且 QUIC 在移动端的表现也会比 TCP 好。因为 TCP 是基于 IP 和端口去识别连接的，这种方式在多变的移动端网络环境下是很脆弱的。但是 QUIC 是通过 ID 的方式去识别一个连接，不管你网络环境如何变化，只要 ID 不变，就能迅速重连上。

### 0-RTT
通过使用类似 TCP 快速打开的技术，缓存当前会话的上下文，在下次恢复会话的时候，只需要将之前的缓存传递给服务端验证通过就可以进行传输了。

### 纠错机制
假如说这次我要发送三个包，那么协议会算出这三个包的异或值并单独发出一个校验包，也就是总共发出了四个包。

当出现其中的非校验包丢包的情况时，可以通过另外三个包计算出丢失的数据包的内容。

当然这种技术只能使用在丢失一个包的情况下，如果出现丢失多个包就不能使用纠错机制了，只能使用重传的方式了。

# HTTP与反向代理
局域网（局域网内部互通）、广域网、互联网

局域网 -> 网关/路由器 -> 互联网

## 正向代理的作用
1. 监控流量（网关、正向代理）
   对网站的访问做限制（防火墙、网关、正向代理）
2. 做一些缓存（将服务器上返回的数据暂时存储在代理上）
3. 科学上网

## 反向代理的作用
1. 加密和SSL加速（可以配置HTTPS）
2. 负载均衡（多台服务器跑同一个应用，反向代理做任务分配）
3. 缓存静态内容（静态内容包括图片、脚本、样式表等）
4. 压缩（浏览器通过识别响应头解压）
5. 减速上传
6. 安全（在Internet和Web server之间加了一层Proxy）
7. 外网发布（请求转发）

nginx upstream块（定义变量，目前理解）

负载均衡的配置：
在upstream里面添加server
